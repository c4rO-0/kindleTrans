{%extends 'NavBar.html.j2'%}

{%block head%}

<title>{{ gettext("在线转化txt为mobi") }}</title>
<script src="{{ url_for('static', filename='Scripts/ConfirmTransformEbook.js') }}"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
{%endblock%}

{%block body%}

    {# 得到file #}
    {% set fileDict = J2SessionQueryFileUpload()  %}


    <h1>{{  gettext( "书名" ) }}</h1>
    <p>  {{ fileDict['filename'] }}</p>


    {#  下载  #}
    {% if 'bookCount' in fileDict.keys() %}
    {# 含有 'bookCount' 说明已经转化完毕, 提供下载#}
        <div>
            {% for i_book in range(1, fileDict['bookCount']+1) %}
                <li>
                    <a href={{ '/TransformDownloads/project-%s.mobi' % i_book }}> 下载-第{{ i_book }}部分/共 {{fileDict['bookCount']}} </a>
                </li>
            {% endfor %}
        </div>
    {% else %} 

    {# 修改目录规则 #}
    <h1>{{  gettext( "修改过滤" ) }}</h1>
    <form id="formTranTitle" method="POST" enctype="multipart/form-data">
        {{ formTran.hidden_tag() }}

        {{ formTran.titleFilter(value= J2sessionQueryTitleFilter()) }}

        {{ formTran.confirmtitleFilter() }}


        {% for error in formTran.titleFilter.errors %}
        <div class="alert alert-danger" role="alert">
            [{{error}}]
        </div>
        {% endfor %}        

    </form>


    <button id="confirmTOCTransfer">确定目录</button>
    {# 没有 'bookCount' 说明还没有确认转化#}
        <h1>{{  gettext( "目录" ) }}</h1>
        <div id='TOC'>
        {{ TOC }}
        </div>



        <form id="formTran" method="POST" enctype="multipart/form-data">
        {{ formTran.hidden_tag() }}

        {# 生成目录 目录不需要显示 #}
        {{ formTran.TOClistindex(style="display: none;") }}

        {# 因为在提交之前要做一些处理, 用confirmTOCTransfer替代#}

        {{ formTran.confirmTOC(style="display: none;") }}

            {% for error in formTran.confirmTOC.errors %}
            <div class="alert alert-danger" role="alert">
                [{{error}}]
            </div>
            {% endfor %}
        </form>
    {% endif %}


{%endblock%}