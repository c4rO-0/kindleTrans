{%extends 'NavBar.html.j2'%}

{%block head%}

<title>{{ gettext("在线转化txt为mobi") }}</title>
<script src="{{ url_for('static', filename='Scripts/ConfirmTransformEbook.js') }}"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
{# 添加谷歌分析 #}
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="{{ url_for('static', filename='js/googleAnalytics.js') }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-119134846-1');
</script>
{%endblock%}

{%block body%}



    {# 得到file #}
    {% set fileDict = J2SessionQueryFileUpload()  %}



    {#  下载  #}
    {# 含有 'bookCount' 说明已经转化完毕, 提供下载#}
    {% if 'bookCount' in fileDict.keys() %}

        <h2> 点击上方广告就是对我们最大的支持 </h2>
        <h3> 不要轻信广告内容, 点开就关上 </h3>
        <\<hr>

        <h1>  {{ fileDict['filename'].rsplit('.',1)[0] }} 转换完成</h1>

        <p> 单击下载通道进行下载；</p>
        

        <div>

            {% if fileDict['bookCount'] == 1 %}
                {# 只有一本书, 不需要在书名后加标号 #}
                <li>
                    <a href={{ '/TransformDownloads/%s/project-1.mobi' % fileDict['saveFileName'] }} download={{ fileDict['filename'].rsplit('.',1)[0]+'.mobi' }}> 下载 {{fileDict['bookCount']}} </a>
                </li>
            {% else %}
                {% for i_book in range(1, fileDict['bookCount']+1) %}
                    <li>
                        <a href={{ '/TransformDownloads/%s/project-%s.mobi' % fileDict['saveFileName'], i_book }} download={{ fileDict['filename'].rsplit('.',1)[0]+'-%s.mobi' % i_book }}> 下载-第{{ i_book }}部分/共 {{fileDict['bookCount']}} </a>
                    </li>
                {% endfor %}
            {% endif %}
        </div>
        <hr />
        <a href="{{url_for('TransformEbook')}}" > 继续转化</a>
    {% else %}  {# 没有 'bookCount' 说明还没有确认转化#}
        <h1>  {{ fileDict['filename'].rsplit('.',1)[0] }} 检测目录</h1>

        {# -----------------#}
        {# 修改目录规则 #}
        <p>若生成目录不符，可更改通配符选择重新生成目录；<p>
        <form id="formTranTitle" method="POST" enctype="multipart/form-data">
            {{ formTran.hidden_tag() }}

            {{ formTran.titleFilter(value= J2sessionQueryTitleFilter()) }}

            {{ formTran.confirmtitleFilter() }}


            {% for error in formTran.titleFilter.errors %}
            <div class="alert alert-danger" role="alert">
                [{{error}}]
            </div>
            {% endfor %}        

        </form>

        <hr />

        {# -----------------#}
        <p>单击确定目录进行转换；</p>
        <p>若初始生成的目录中出现错误生成章节，可单击对应位置，此时章节显示红色，再随后生成的mobi中即可删除此章节目录；</p>

        <button id="confirmTOCTransfer">确定目录</button>
        
        <hr /> 

        {# -----------------#}
        <h2>{{  gettext( "目录" ) }}</h2>
        <div id='TOC'>
        {{ TOC }}
        </div>



        <form id="formTran" method="POST" enctype="multipart/form-data">
        {{ formTran.hidden_tag() }}

        {# 生成目录 目录不需要显示 #}
        {{ formTran.TOClistindex(style="display: none;") }}

        {# 因为在提交之前要做一些处理, 用confirmTOCTransfer替代#}

        {{ formTran.confirmTOC(style="display: none;") }}

            {% for error in formTran.confirmTOC.errors %}
            <div class="alert alert-danger" role="alert">
                [{{error}}]
            </div>
            {% endfor %}
        </form>
    {% endif %}


{%endblock%}